services:
  db:
    image: postgres:18-alpine
    container_name: db
    env_file: [.env]
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_PORT: ${DB_PORT:-5432}
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 2s
      timeout: 2s
      retries: 10
    restart: unless-stopped

  migrator:
    image: ghcr.io/jackc/tern:latest
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./db/migrations:/migrations
    env_file: [.env]
    command:
      - sh
      - -lc
      - |
        cat > /tmp/tern.conf <<EOF
        database = "postgres://${DB_USER}:${DB_PASSWORD}@db:${DB_PORT}/${DB_NAME}?sslmode=disable"
        EOF
        tern migrate -m /migrations -c /tmp/tern.conf up
    restart: "no"

  auth_service:
    build:
      context: .
      dockerfile: ./auth_service/Dockerfile
    container_name: auth_service
    depends_on:
      db:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    # внешний порт = внутренний порт = AUTH_PORT
    ports:
      - "${AUTH_PORT}:${AUTH_PORT}"
    env_file: [.env]
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      APP_PORT: "${AUTH_PORT}"
      SECRET_KEY: ${SECRET_KEY}
      CSRF_SECRET: ${CSRF_SECRET}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      COOKIE_SECURE: ${COOKIE_SECURE}
      COOKIE_SAMESITE: ${COOKIE_SAMESITE}
    restart: unless-stopped

  profile_service:
    build:
      context: .
      dockerfile: ./profile_service/Dockerfile
    container_name: profile_service
    depends_on:
      db:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    # внешний порт = внутренний порт = PROFILE_SERVICE_PORT
    ports:
      - "${PROFILE_SERVICE_PORT}:${PROFILE_SERVICE_PORT}"
    env_file: [.env]
    environment:
      POSTGRES_HOST: ${DB_HOST}
      POSTGRES_PORT: ${DB_PORT}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      PROFILE_SERVICE_PORT: "${PROFILE_SERVICE_PORT}"
      UPLOAD_PATH: ${UPLOAD_DIR:-/app/avatars}
      BASE_URL: http://localhost:${PROFILE_SERVICE_PORT}
      SECRET_KEY: ${SECRET_KEY}
      CSRF_SECRET: ${CSRF_SECRET}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      COOKIE_SECURE: ${COOKIE_SECURE}
      COOKIE_SAMESITE: ${COOKIE_SAMESITE}
    volumes:
      - ./.data/avatars:/app/avatars
    restart: unless-stopped

  store_service:
    build:
      context: .
      dockerfile: ./store_service/Dockerfile
    container_name: store_service
    depends_on:
      db:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
      auth_service:
        condition: service_started
    # внешний порт = внутренний порт = STORE_SERVICE_PORT
    ports:
      - "${STORE_SERVICE_PORT}:${STORE_SERVICE_PORT}"
    env_file: [.env]
    environment:
      # store конфиг читает POSTGRES_* и DB_NAME
      POSTGRES_HOST: ${DB_HOST}
      POSTGRES_PORT: ${DB_PORT}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      APP_PORT: "${STORE_SERVICE_PORT}"
      AUTH_URL: http://auth_service:${AUTH_PORT}
      SECRET_KEY: ${SECRET_KEY}
      CSRF_SECRET: ${CSRF_SECRET}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      COOKIE_SECURE: ${COOKIE_SECURE}
      COOKIE_SAMESITE: ${COOKIE_SAMESITE}
    restart: unless-stopped

volumes:
  db_data: {}